name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: read

jobs:
  release-cli:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-gui:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd frontend && pnpm install

      - name: Build for darwin/amd64
        run: wails build -platform darwin/amd64 -o Snipgo-amd64

      - name: Build for darwin/arm64
        run: wails build -platform darwin/arm64 -o Snipgo-arm64

      - name: Create Universal Binary
        run: |
          mkdir -p build/bin/Snipgo.app/Contents/MacOS
          
          # Copy the arm64 app structure as base
          cp -R build/bin/Snipgo-arm64.app/* build/bin/Snipgo.app/
          
          # Create universal binary using lipo
          lipo -create \
            build/bin/Snipgo-amd64.app/Contents/MacOS/Snipgo-amd64 \
            build/bin/Snipgo-arm64.app/Contents/MacOS/Snipgo-arm64 \
            -output build/bin/Snipgo.app/Contents/MacOS/Snipgo
          
          # Update Info.plist executable name
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable Snipgo" build/bin/Snipgo.app/Contents/Info.plist
          
          # Clean up architecture-specific builds
          rm -rf build/bin/Snipgo-amd64.app build/bin/Snipgo-arm64.app

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create zip archive
        run: |
          cd build/bin
          zip -r Snipgo_${{ steps.version.outputs.VERSION }}_darwin_universal.zip Snipgo.app

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/bin/Snipgo_${{ steps.version.outputs.VERSION }}_darwin_universal.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          SHA256=$(shasum -a 256 build/bin/Snipgo_${VERSION}_darwin_universal.zip | cut -d ' ' -f 1)
          
          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/atobaum/homebrew-tap.git
          cd homebrew-tap
          
          # Create Casks directory if not exists
          mkdir -p Casks
          
          # Create/update cask formula
          cat > Casks/snipgo-gui.rb << EOF
          cask "snipgo-gui" do
            version "${VERSION}"
            sha256 "${SHA256}"
          
            url "https://github.com/atobaum/snipgo/releases/download/v#{version}/Snipgo_#{version}_darwin_universal.zip"
            name "Snipgo"
            desc "Local-First Snippet Manager"
            homepage "https://github.com/atobaum/snipgo"
          
            app "Snipgo.app"
          
            zap trash: [
              "~/.snipgo",
            ]
          end
          EOF
          
          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/snipgo-gui.rb
          git commit -m "Update snipgo-gui to ${VERSION}" || echo "No changes to commit"
          git push
