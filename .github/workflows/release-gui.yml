name: Release GUI

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-gui:
    runs-on: macos-latest
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Validate tag
        run: |
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Please run this workflow from a version tag (e.g., v1.0.0)"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd frontend && pnpm install

      - name: Build for darwin/amd64
        run: wails build -platform darwin/amd64 -o Snipgo-amd64

      - name: Build for darwin/arm64
        run: wails build -platform darwin/arm64 -o Snipgo-arm64

      - name: Create Universal Binary
        run: |
          mkdir -p build/bin/Snipgo.app/Contents/MacOS

          # Copy the arm64 app structure as base
          cp -R build/bin/Snipgo-arm64.app/* build/bin/Snipgo.app/

          # Create universal binary using lipo
          lipo -create \
            build/bin/Snipgo-amd64.app/Contents/MacOS/Snipgo-amd64 \
            build/bin/Snipgo-arm64.app/Contents/MacOS/Snipgo-arm64 \
            -output build/bin/Snipgo.app/Contents/MacOS/Snipgo

          # Update Info.plist executable name
          /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable Snipgo" build/bin/Snipgo.app/Contents/Info.plist

          # Clean up architecture-specific builds
          rm -rf build/bin/Snipgo-amd64.app build/bin/Snipgo-arm64.app

      - name: Create zip archive
        run: |
          cd build/bin
          zip -r Snipgo_${VERSION#v}_darwin_universal.zip Snipgo.app

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: build/bin/Snipgo_*_darwin_universal.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          # Remove 'v' prefix for version number
          SEMVER=${VERSION#v}
          SHA256=$(shasum -a 256 build/bin/Snipgo_${SEMVER}_darwin_universal.zip | cut -d ' ' -f 1)

          # Clone homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/atobaum/homebrew-tap.git
          cd homebrew-tap

          # Create Casks directory if not exists
          mkdir -p Casks

          # Create/update cask formula
          cat > Casks/snipgo-gui.rb << EOF
          cask "snipgo-gui" do
            version "${SEMVER}"
            sha256 "${SHA256}"

            url "https://github.com/atobaum/snipgo/releases/download/v#{version}/Snipgo_#{version}_darwin_universal.zip"
            name "Snipgo"
            desc "Local-First Snippet Manager"
            homepage "https://github.com/atobaum/snipgo"

            app "Snipgo.app"

            zap trash: [
              "~/.snipgo",
            ]
          end
          EOF

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/snipgo-gui.rb
          git commit -m "Update snipgo-gui to ${SEMVER}" || echo "No changes to commit"
          git push
